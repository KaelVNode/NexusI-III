#!/bin/bash

set -e

# Menampilkan ASCII Art untuk "Saandy"
echo "
  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–„â–„â–„     â–„â–„â–„      â–ˆâ–ˆâ–ˆâ–„    â–ˆâ–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–ˆâ–ˆ   â–ˆâ–ˆâ–“
â–’â–ˆâ–ˆ    â–’â–’â–ˆâ–ˆâ–ˆâ–ˆâ–„  â–’â–ˆâ–ˆâ–ˆâ–ˆâ–„    â–ˆâ–ˆ â–€â–ˆ   â–ˆâ–’â–ˆâ–ˆâ–€ â–ˆâ–ˆâ–’â–ˆâ–ˆ  â–ˆâ–ˆâ–’
â–‘ â–“â–ˆâ–ˆâ–„  â–’â–ˆâ–ˆ  â–€â–ˆâ–„â–’â–ˆâ–ˆ  â–€â–ˆâ–„ â–“â–ˆâ–ˆ  â–€â–ˆ â–ˆâ–ˆâ–‘â–ˆâ–ˆ   â–ˆâ–Œâ–’â–ˆâ–ˆ â–ˆâ–ˆâ–‘
  â–’   â–ˆâ–ˆâ–‘â–ˆâ–ˆâ–„â–„â–„â–„â–ˆâ–‘â–ˆâ–ˆâ–„â–„â–„â–„â–ˆâ–ˆâ–“â–ˆâ–ˆâ–’  â–â–Œâ–ˆâ–ˆâ–‘â–“â–ˆâ–„   â–Œâ–‘ â–â–ˆâ–ˆâ–“â–‘
â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’â–’â–“â–ˆ   â–“â–ˆâ–ˆâ–“â–ˆ   â–“â–ˆâ–ˆâ–’â–ˆâ–ˆâ–‘   â–“â–ˆâ–ˆâ–‘â–’â–ˆâ–ˆâ–ˆâ–ˆâ–“ â–‘ â–ˆâ–ˆâ–’â–“â–‘
â–’ â–’â–“â–’ â–’ â–‘â–’â–’   â–“â–’â–ˆâ–’â–’   â–“â–’â–ˆâ–‘ â–’â–‘   â–’ â–’ â–’â–’â–“  â–’  â–ˆâ–ˆâ–’â–’â–’ 
â–‘ â–‘â–’  â–‘ â–‘ â–’   â–’â–’ â–‘â–’   â–’â–’ â–‘ â–‘â–‘   â–‘ â–’â–‘â–‘ â–’  â–’â–“â–ˆâ–ˆ â–‘â–’â–‘ 
â–‘  â–‘  â–‘   â–‘   â–’   â–‘   â–’     â–‘   â–‘ â–‘ â–‘ â–‘  â–‘â–’ â–’ â–‘â–‘  
      â–‘       â–‘  â–‘    â–‘  â–‘        â–‘   â–‘   â–‘ â–‘     
                                    â–‘     â–‘ â–‘     
"

# Minta Node ID dari pengguna
read -p "Masukkan NODE ID Anda: " NODE_ID

if [[ -z "$NODE_ID" ]]; then
    echo "âŒ NODE ID tidak boleh kosong. Silakan jalankan ulang dan isi dengan benar."
    exit 1
fi

# Perbarui dan instal dependensi
echo "ðŸ“¦ Memperbarui sistem dan menginstal dependensi..."
sudo apt update && sudo apt upgrade -y
sudo apt install protobuf-compiler build-essential pkg-config libssl-dev curl git -y

# Install Rust
echo "ðŸ¦€ Menginstal Rust..."
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
source "$HOME/.cargo/env"

# Clone dan build Nexus CLI
echo "ðŸ“¥ Meng-clone dan membangun Nexus CLI..."
git clone https://github.com/nexus-xyz/nexus-cli
cd nexus-cli/clients/cli
cargo build --release
cd ~

# Buat systemd service
echo "âš™ï¸ Membuat systemd service untuk Nexus..."
SERVICE_FILE=/etc/systemd/system/nexus.service
sudo tee $SERVICE_FILE > /dev/null <<EOF
[Unit]
Description="Nexus Proving"
After=network-online.target

[Service]
Type=simple
User=$USER
ExecStart=$HOME/nexus-cli/clients/cli/target/release/nexus-network start --node-id $NODE_ID --headless
Restart=always
RestartSec=2
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF

# Aktifkan dan jalankan layanan
echo "ðŸš€ Menjalankan layanan Nexus..."
sudo systemctl daemon-reload
sudo systemctl enable nexus
sudo systemctl start nexus

# Tampilkan log
echo "ðŸ“„ Menampilkan log Nexus. Tekan Ctrl+C untuk keluar."
journalctl -fu nexus -o cat
